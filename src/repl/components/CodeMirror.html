<div class='codemirror-container'>
	<textarea ref:editor></textarea>
</div>

<style>
	.codemirror-container {
		width: 100%;
		height: 100%;
	}

	.codemirror-container .CodeMirror {
		height: 100%;
	}

	textarea {
		width: 100%;
		height: 100%;
		border: none;
	}
</style>

<script>
	export default {
		onrender () {
			let updating = false;

			this.editor = window.CodeMirror.fromTextArea( this.refs.editor, {
				lineNumbers: true,
				lineWrapping: true,
				value: this.get( 'code' ),
				mode: this.get( 'mode' ),
				readOnly: this.get( 'readonly' )
			});

			// TODO this is a bug. onrender should only be called once
			// the component is actually in the DOM
			setTimeout( () => {
				this.editor.refresh();
			});

			this.editor.on( 'change', instance => {
				if ( !updating ) {
					updating = true;
					this.set({ code: instance.getValue() });
					updating = false;
				}
			});

			this.observe( 'code', code => {
				if ( !updating && code != null ) {
					updating = true;
					this.editor.setValue( code );
					updating = false;
				}
			});

			this.on( 'teardown', () => {
				this.editor.toTextArea();
			});
		},

		methods: {
			resize () {
				this.editor.refresh();
			}
		}
	};
</script>
